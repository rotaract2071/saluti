<!DOCTYPE html>
<html lang="it" data-theme="dark">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>👋</text></svg>" />
	<title>Saluti!</title>
	<link rel="stylesheet" href="pico.min.css" />
	<style>
		@font-face {
			font-family: 'Open Sans';
			font-style: normal;
			font-weight: 300 800;
			font-stretch: 100%;
			font-display: swap;
			src: url(OpenSans.woff2) format('woff2');
			unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
		}

		* {
			font-family: 'Open Sans', system-ui, sans-serif;
		}

		fieldset {
			border: var(--pico-border-width) solid var(--pico-form-element-border-color);
			border-radius: var(--pico-border-radius);
			padding: var(--pico-spacing);
			background: var(--pico-card-background-color);
		}

		.sticky {
			position: sticky;
			top: var(--pico-spacing);
		}

		@media print {
			* {
				background-color: white;
				color: black !important;
			}

			h1,
			#participants,
			button,
			footer {
				display: none;
			}

			.sticky {
				position: static;
			}
		}
	</style>
	<script type="module">
		// @ts-check

		const form = /** @type {HTMLFormElement} */ (document.querySelector("form"))
		const template = /** @type {HTMLTemplateElement} */ (document.querySelector("template"))
		const addButton = /** @type {HTMLButtonElement} */ (document.getElementById("add"))
		const shareButton = /** @type {HTMLButtonElement} */ (document.getElementById("share"))
		const ol = /** @type {HTMLOListElement} */ (document.querySelector("ol"))
		const currentYearSpan = /** @type {HTMLSpanElement} */ (document.getElementById("currentYear"))

		const now = new Date()
		const currentYear = now.getFullYear() - (now.getMonth() <= 6 ? 1 : 0)

		form.addEventListener("submit", (e) => e.preventDefault())
		form.addEventListener("submit", renderList)
		new MutationObserver(renderList).observe(form, { childList: true })

		addButton.addEventListener("click", () => {
			const fieldset = /** @type {HTMLFieldSetElement} */ (/** @type {HTMLFieldSetElement} */ (template.content.firstElementChild).cloneNode(true))
			const nameInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="name"]'))
			const roleSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="role"]'))
			const associationSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="association"]'))
			const yearInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="year"]'))
			const clubSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="club"]'))
			const clubFoundationDateInput = /** @type {HTMLInputElement} */(fieldset.querySelector('input[name="club-foundation-date"]'))
			const removeButton = /** @type {HTMLButtonElement} */ (fieldset.querySelector("button.remove"))

			nameInput.addEventListener("input", requestFormSubmit)
			roleSelect.addEventListener("change", requestFormSubmit)
			associationSelect.addEventListener("change", () => filterRoles(roleSelect.options, associationSelect.selectedOptions[0].innerText))
			associationSelect.addEventListener("change", requestFormSubmit)
			yearInput.addEventListener("input", requestFormSubmit)
			clubSelect.addEventListener("input", () => setClubFoundationDate(clubSelect, clubFoundationDateInput))
			clubSelect.addEventListener("input", requestFormSubmit)
			clubFoundationDateInput.addEventListener("input", requestFormSubmit)
			removeButton.addEventListener("click", () => fieldset.remove())

			yearInput.value = currentYear.toString()
			filterRoles(roleSelect.options, associationSelect.selectedOptions[0].innerText)
			setClubFoundationDate(clubSelect, clubFoundationDateInput)
			form.append(fieldset)
			nameInput.focus()
		})

		shareButton.addEventListener("click", () => {
			const text = listToText(ol)
			if (text === "") {
				alert("Inserisci almeno un nominativo.")
				return
			}
			try {
				navigator.share({ text })
			} catch {
				navigator.clipboard.writeText(text)
				alert("Saluti copiati negli appunti!")
			}
		})

		currentYearSpan.innerText = `${currentYear}/${currentYear + 1}`
		addButton.click()

		/** @typedef {{name: string, role: string, association: string, roleSortOrder: number, associationSortOrder: number, year: number, clubFoundationDate: Date}} Person */

		function requestFormSubmit() {
			form.requestSubmit()
		}

		/**
		 * @param {HTMLOptionsCollection} optionsCollection
		 * @param {string} association
		 */
		function filterRoles(optionsCollection, association) {
			const options = Array.from(optionsCollection)
			options.forEach((el) => {
				el.style.display = "none"
			})
			options
				.filter((option) => option.dataset.association === undefined || option.dataset.association === association)
				.forEach((option) => option.style.removeProperty("display"))
			options
				.filter((option) => option.style.display === "")[0].selected = true
		}

		/**
		 * @param {HTMLSelectElement} clubSelect
		 * @param {HTMLInputElement} clubFoundationDateInput
		 */
		function setClubFoundationDate(clubSelect, clubFoundationDateInput) {
			clubFoundationDateInput.value = clubSelect.value
		}

		function renderList() {
			ol.replaceChildren(...Array
				.from(form.querySelectorAll("fieldset"))
				.map(fieldsetToPerson)
				.filter(personHasNameAndYear)
				.sort(sortPeople)
				.map(personToListItem)
			)
		}

		/**
		 * @param {HTMLOListElement} ol
		 * @returns {string}
		 */
		function listToText(ol) {
			return Array
				.from(ol.querySelectorAll("li"))
				.map((li, index) => `${index + 1} - ${li.innerText}`)
				.join("\n\n")
		}

		/**
		 * @param {HTMLFieldSetElement} fieldset
		 * @returns {Person}
		 */
		function fieldsetToPerson(fieldset) {
			const nameInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="name"]'))
			const roleSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="role"]'))
			const associationSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="association"]'))
			const yearInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="year"]'))
			const clubFoundationDateInput = /** @type {HTMLInputElement} */(fieldset.querySelector('input[name="club-foundation-date"]'))

			return {
				name: nameInput.value,
				role: roleSelect.selectedOptions[0].innerText,
				association: associationSelect.selectedOptions[0].innerText,
				roleSortOrder: parseInt(roleSelect.value),
				associationSortOrder: parseInt(associationSelect.value),
				year: parseInt(yearInput.value),
				clubFoundationDate: new Date(clubFoundationDateInput.value),
			}
		}

		/**
		 * @param {Person} person
		 * @returns {boolean}
		 */
		function personHasNameAndYear({ name, year }) {
			return name !== "" && !isNaN(year)
		}

		/**
		 * @param {Person} a
		 * @param {Person} b
		 * @returns {number}
		 */
		function sortPeople(a, b) {
			// Se hanno cariche diverse, ordina per carica
			if (a.roleSortOrder !== b.roleSortOrder) return a.roleSortOrder - b.roleSortOrder

			// Hanno la stessa carica

			// Se hanno anni diversi
			if (a.year !== b.year) {
				// Gli in carica hanno sempre la precedenza
				if (a.year === currentYear) return -1
				if (b.year === currentYear) return 1

				// Gli immediate past vengono subito dopo
				if (a.year === currentYear - 1) return -1
				if (b.year === currentYear - 1) return 1

				// Altrimenti, ordina per anno crescente
				return a.year - b.year
			}

			// Hanno stessa carica e stesso anno

			// Se associazioni diverse
			if (a.association !== b.association) {
				// Caso particolare: Governatore/R.D. dell'anno corrente
				// In questo caso si dà precedenza al Rotary
				if (a.roleSortOrder === 1 && a.year === currentYear) {
					if (a.association === "Rotary") return -1
					if (b.association === "Rotary") return 1
				}

				// Ordina per associazione
				return a.associationSortOrder - b.associationSortOrder
			}

			// Hanno stessa carica, stesso anno e stessa associazione

			// Ordina per data di fondazione del club
			return a.clubFoundationDate.getTime() - b.clubFoundationDate.getTime()
		}

		/**
		 * @param {Person} person
		 * @returns {HTMLLIElement}
		 */
		function personToListItem(person) {
			const li = document.createElement("li")
			const b = document.createElement("b")
			b.innerText = person.name
			li.append(b)
			const role = person.role
			li.innerHTML += `<br><small>${role} ${person.association}<br>A.R. ${person.year}/${person.year + 1}</small>`
			return li
		}
	</script>
</head>

<body class="container">
	<noscript>Abilita JavaScript per utilizzare questa web app.</noscript>
	<main>
		<h1>Saluti!</h1>
		<div class="grid">
			<section id="participants">
				<h2>Partecipanti</h2>
				<form>
					<template>
						<fieldset>
							<label>
								Nome
								<input type="text" name="name" placeholder="Nome" autocapitalize="words" autocomplete="name">
							</label>
							<label>
								Associazione
								<select name="association">
									<option value="1">Rotaract</option>
									<option value="2">Rotary</option>
									<option value="3">Interact</option>
								</select>
							</label>
							<label>
								Carica
								<select name="role">
									<optgroup label="Direttivo distrettuale">
										<option data-association="Rotary" value="001">Governatore</option>
										<option data-association="Rotaract" value="001">Rappresentante Distrettuale</option>
										<option data-association="Interact" value="001">Rappresentante Distrettuale</option>
										<option value="003">Relatore</option>
										<option value="004">Carica politica</option>
										<option value="005">Carica militare</option>
										<option value="006">Carica ecclesiastica</option>
										<option value="007">Segretario Distrettuale</option>
										<option value="008">Tesoriere Distrettuale</option>
										<option value="009">Prefetto Distrettuale</option>
									</optgroup>
									<optgroup label="Esecutivo distrettuale">
										<option data-association="Rotary" value="101">Assistente del Governatore</option>
										<option data-association="Rotaract" value="101">Presidente Commissione Azione Interna</option>
										<option data-association="Rotaract" value="102">Presidente Commissione Azione Interesse Pubblico</option>
										<option data-association="Rotaract" value="103">Presidente Commissione Azione Internazionale</option>
										<option data-association="Rotaract" value="104">Presidente Commissione Azione Nuove Generazioni</option>
										<option data-association="Rotaract" value="105">Presidente Commissione Azione Professionale</option>
										<option data-association="Rotaract" value="106">Presidente Commissione Comunicazione e Informatica</option>
										<option data-association="Rotaract" value="107">Presidente Commissione Cultura</option>
										<option data-association="Rotaract" value="108">Presidente Commissione Regolamento</option>
										<option data-association="Rotaract" value="109">Presidente Commissione Revisione dei Conti</option>
										<option data-association="Rotaract" value="110">Presidente Commissione Sport</option>
										<option data-association="Rotaract" value="111">Presidente Sottocommissione Fondazione Rotary</option>
										<option data-association="Rotaract" value="112">Presidente Sottocommissione Sviluppo Effettivo</option>
										<option data-association="Rotaract" value="113">Delegato di zona</option>
									</optgroup>
									<optgroup label="Cariche di club">
										<option value="200">Presidente</option>
										<option data-association="Rotary" value="201">Delegato Rotary per il Rotaract</option>
										<option value="202">Vicepresidente</option>
										<option value="203">Segretario</option>
										<option value="204">Tesoriere</option>
										<option value="205">Prefetto</option>
										<option value="206">Consigliere</option>
										<option value="207">Socio</option>
									</optgroup>
								</select>
							</label>
							<label>
								A.R.
								<input type="number" name="year" min="1900" max="2100" placeholder="A.R.">
							</label>
							<details>
								<summary>Campi opzionali</summary>
								<label>
									Club
									<select name="club">
										<option value="1968-12-05">Arezzo</option>
										<option value="1968-04-11">Carrara e Massa</option>
										<option value="2004-05-28">Cascina</option>
										<option value="2015-05-22">Casentino</option>
										<option value="2011-06-16">Cecina Rosignano</option>
										<option value="2014-06-08">Chianciano Chiusi Montepulciano</option>
										<option value="1969-05-22">Empoli</option>
										<option value="1994-06-13">Fiesole</option>
										<option value="1968-03-18">Firenze</option>
										<option value="2008-05-30">Firenze Bisenzio</option>
										<option value="2005-06-27">Firenze Centenario</option>
										<option value="2001-12-04">Firenze Certosa</option>
										<option value="1968-09-07">Firenze Est</option>
										<option value="1981-05-13">Firenze Nord</option>
										<option value="2016-04-27">Firenze Sesto Calenzano</option>
										<option value="1987-03-14">Firenze Sud</option>
										<option value="1984-07-15">Follonica</option>
										<option value="1987-05-25">Grosseto</option>
										<option value="2014-07-04">Isola D'Elba</option>
										<option value="1969-02-04">Lucca</option>
										<option value="2016-11-18">Monte Argentario</option>
										<option value="1982-05-12">Mugello</option>
										<option value="2005-07-23">Piombino</option>
										<option value="1970-03-07">Pisa</option>
										<option value="1977-05-30">Pistoia Montecatini Terme</option>
										<option value="1988-01-01">Pontedera</option>
										<option value="1968-05-05">Prato</option>
										<option value="2012-01-07">Rosignano Solvay</option>
										<option value="2014-06-30">San Casciano Chianti</option>
										<option value="1969-03-14">Siena</option>
										<option value="2015-05-04">Valdarno Fiorentino</option>
										<option value="2015-06-28">Valdarno Masaccio</option>
										<option value="1968-05-26">Viareggio Versilia</option>
										<option value="1984-04-02">Volterra</option>
									</select>
								</label>
								<label>
									Data di fondazione del Club
									<input type="date" name="club-foundation-date">
								</label>
								<small>Specifica la data di fondazione del Club per dirimere eventuali spareggi.</small>
							</details>
							<button type="button" class="secondary outline remove">🗑️ Rimuovi</button>
						</fieldset>
					</template>
				</form>
				<button type="button" id="add">➕ Aggiungi</button>
			</section>
			<section>
				<h2>Ordine dei saluti</h2>
				<div class="sticky">
					<button type="button" id="share">🔁 Condividi</button>
					<button type="button" onclick="window.print()">🖨️ Stampa</button>
					<ol></ol>
				</div>
			</section>
		</div>
	</main>
	<footer style="text-align: center">
		<small>
			Credits: <a href="https://danieleambrosino.it" target="_blank">Daniele Ambrosino</a>, <a href="https://linktr.ee/grazia_pachioli" target="_blank">Grazia Pachioli</a>, <a href="https://instagram.com/malvinarosseti" target="_blank">Malvina Rosseti</a>
			<br>
			<a target="_blank" href="https://rotaract2071.org">Distretto Rotaract 2071</a>
			<br>
			Comm. Comunicazione e Informatica A.R. 2024/2025
			<br>
			L'algoritmo considera come annata corrente l'A.R. <span id="currentYear"></span>
		</small>
	</footer>
</body>

</html>