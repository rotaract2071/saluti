<!DOCTYPE html>
<html lang="it" data-theme="dark">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>üëã</text></svg>"></link>
	<title>Saluti!</title>
	<link rel="stylesheet" href="pico.min.css" />
	<style>
		@font-face {
			font-family: 'Open Sans';
			font-style: normal;
			font-weight: 300 800;
			font-stretch: 100%;
			font-display: swap;
			src: url(OpenSans.woff2) format('woff2');
			unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
		}

		* {
			font-family: 'Open Sans', system-ui, sans-serif;
		}

		fieldset {
			border: var(--pico-border-width) solid var(--pico-form-element-border-color);
			border-radius: var(--pico-border-radius);
			padding: var(--pico-spacing);
			background: var(--pico-card-background-color);
		}

		@media print {
			* {
				background-color: white;
				color: black !important;
			}

			h1,
			#participants,
			button,
			footer {
				display: none;
			}
		}
	</style>
	<script type="module">
		// @ts-check

		const form = /** @type {HTMLFormElement} */ (document.querySelector("form"))
		const template = /** @type {HTMLTemplateElement} */ (document.querySelector("template"))
		const addButton = /** @type {HTMLButtonElement} */ (document.getElementById("add"))
		const shareButton = /** @type {HTMLButtonElement} */ (document.getElementById("share"))
		const ol = /** @type {HTMLOListElement} */ (document.querySelector("ol"))
		const currentYearSpan = /** @type {HTMLSpanElement} */ (document.getElementById("currentYear"))

		const now = new Date()
		const currentYear = now.getFullYear() - (now.getMonth() <= 6 ? 1 : 0)
		currentYearSpan.innerText = `${currentYear}/${currentYear + 1}`

		addButton.addEventListener("click", () => {
			const fieldset = /** @type {HTMLFieldSetElement} */ (/** @type {HTMLFieldSetElement} */ (template.content.firstElementChild).cloneNode(true))
			const nameInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="name"]'))
			const roleSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="role"]'))
			const associationSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="association"]'))
			const yearInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="year"]'))
			const removeButton = /** @type {HTMLButtonElement} */(fieldset.querySelector("button.remove"))

			nameInput.addEventListener("input", requestFormSubmit)
			roleSelect.addEventListener("change", requestFormSubmit)
			associationSelect.addEventListener("change", requestFormSubmit)
			yearInput.addEventListener("input", requestFormSubmit)
			removeButton.addEventListener("click", () => fieldset.remove())

			yearInput.value = currentYear.toString()
			form.append(fieldset);
			nameInput.focus()
		})

		form.addEventListener("submit", (e) => e.preventDefault())
		form.addEventListener("submit", renderList)
		new MutationObserver(renderList).observe(form, { childList: true })

		shareButton.addEventListener("click", () => {
			const text = listToText(ol)
			if (text === "") {
				alert("Inserisci almeno un nominativo.")
				return
			}
			try {
				navigator.share({ text })
			} catch {
				navigator.clipboard.writeText(text)
				alert("Saluti copiati negli appunti!")
			}
		})

		addButton.click()

		/** @typedef {{name: string, role: string, association: string, roleSortOrder: number, associationSortOrder: number, year: number}} Item */

		function requestFormSubmit() {
			form.requestSubmit()
		}

		function renderList() {
			const listItems = Array.from(form.querySelectorAll("fieldset"))
				.map(fieldsetToItem)
				.filter(nonEmptyItem)
				.sort(sortItems)
				.map(itemToListItem)
			ol.innerHTML = ""
			ol.append(...listItems)
		}

		/**
		 * @param {HTMLOListElement} ol
		 * @returns {string}
		 */
		function listToText(ol) {
			return Array.from(ol.querySelectorAll("li"))
				.map((li, index) => `${index + 1} - ${li.innerText}`)
				.join("\n\n")
		}

		/**
		 * @param {HTMLFieldSetElement} fieldset
		 * @returns {Item}
		 */
		function fieldsetToItem(fieldset) {
			const nameInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="name"]'))
			const roleSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="role"]'))
			const associationSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="association"]'))
			const yearInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="year"]'))

			return {
				name: nameInput.value,
				role: roleSelect.selectedOptions[0].innerText,
				association: associationSelect.selectedOptions[0].innerText,
				roleSortOrder: parseInt(roleSelect.value),
				associationSortOrder: parseInt(associationSelect.value),
				year: parseInt(yearInput.value),
			}
		}

		/**
		 * @param {Item} item
		 * @returns {boolean}
		 */
		function nonEmptyItem({ name, year }) {
			return name !== "" && !isNaN(year)
		}

		/**
		 * Roughly equivalent to a SQL ordering clause along the lines of
		 * `ORDER BY roleSortOrder ASC, year ASC, associationSortOrder ASC`
		 * with special handling for the current year case.
		 *
		 * @param {Item} a
		 * @param {Item} b
		 * @returns number
		 */
		function sortItems(a, b) {
			if (a.roleSortOrder !== b.roleSortOrder) {
				return a.roleSortOrder - b.roleSortOrder
			}
			if (a.year === currentYear) return -1
			if (b.year === currentYear) return 1
			if (a.year !== b.year) {
				return a.year - b.year
			}
			return a.associationSortOrder - b.associationSortOrder
		}

		/**
		 * @param {Item} item
		 * @returns {HTMLLIElement}
		 */
		function itemToListItem(item) {
			const li = document.createElement("li")
			const b = document.createElement("b")
			b.innerText = item.name
			li.append(b)
			let role = item.role
			if (item.roleSortOrder === 1) {
				role = item.association === "Rotary" ? "Governatore" : "Rappresentante Distrettuale"
			}
			li.innerHTML += `<br><small>${role} ${item.association}<br>A.R. ${item.year}/${item.year + 1}</small>`
			return li
		}
	</script>
</head>

<body class="container">
	<noscript>Abilita JavaScript per utilizzare questa web app.</noscript>
	<main>
		<h1>Saluti!</h1>
		<div class="grid">
			<section id="participants">
				<h2>Partecipanti</h2>
				<form>
					<template>
						<fieldset>
							<label>
								Nome
								<input type="text" name="name" placeholder="Nome" autocapitalize="words" autocomplete="name">
							</label>
							<label>
								Carica
								<select name="role">
									<optgroup label="Direttivo distrettuale">
										<option value="001">Rappresentante Distrettuale/Governatore</option>
										<option value="002">Segretario Distrettuale</option>
										<option value="003">Tesoriere Distrettuale</option>
										<option value="004">Prefetto Distrettuale</option>
									</optgroup>
									<optgroup label="Esecutivo distrettuale">
										<option value="010">Presidente Commissione Azione Interna</option>
										<option value="011">Delegato di zona</option>
										<option value="012">Presidente Commissione Azione Interesse Pubblico</option>
										<option value="013">Presidente Commissione Azione Internazionale</option>
										<option value="014">Presidente Commissione Azione Nuove Generazioni</option>
										<option value="015">Presidente Commissione Azione Professionale</option>
										<option value="016">Presidente Commissione Comunicazione e Informatica</option>
										<option value="017">Presidente Commissione Cultura</option>
										<option value="018">Presidente Commissione Regolamento</option>
										<option value="019">Presidente Commissione Revisione dei Conti</option>
										<option value="020">Presidente Commissione Sport</option>
										<option value="021">Presidente Sottocommissione Fondazione Rotary</option>
										<option value="022">Presidente Sottocommissione Sviluppo Effettivo</option>
										<option value="023">Membro di commissione</option>
									</optgroup>
									<optgroup label="Cariche di club">
										<option value="100">Presidente</option>
										<option value="101">Vicepresidente</option>
										<option value="103">Segretario</option>
										<option value="104">Tesoriere</option>
										<option value="105">Prefetto</option>
										<option value="106">Consigliere</option>
										<option value="107">Socio</option>
									</optgroup>
								</select>
							</label>
							<div role="group">
								<label>
									Associazione
									<select name="association">
										<option value="1">Rotary</option>
										<option value="2" selected>Rotaract</option>
										<option value="3">Interact</option>
									</select>
								</label>
								<label>
									A.R.
									<input type="number" name="year" min="1900" max="2100" placeholder="A.R.">
								</label>
							</div>
							<button type="button" class="secondary outline remove">üóëÔ∏è Rimuovi</button>
						</fieldset>
					</template>
				</form>
				<button type="button" id="add">‚ûï Aggiungi</button>
			</section>
			<section>
				<h2>Ordine dei saluti</h2>
				<div style="position: sticky; top: var(--pico-spacing)">
					<button type="button" id="share">üîÅ Condividi</button>
					<button type="button" onclick="window.print()">üñ®Ô∏è Stampa</button>
					<ol></ol>
				</div>
			</section>
		</div>
	</main>
	<footer style="text-align: center">
		<small>
			Credits: <a href="https://danieleambrosino.it" target="_blank">Daniele</a> (üíª), Malvina e Grazia (üñºÔ∏è)
			<br>
			Comm. Comunicazione e Informatica A.R. 2024/25 ‚úåÔ∏è
			<br>
			L'algoritmo considera come annata corrente l'A.R. <span id="currentYear"></span>
		</small>
	</footer>
</body>

</html>