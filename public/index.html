<!DOCTYPE html>
<html lang="it">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Saluti</title>
	<style>
		@font-face {
			font-family: 'Open Sans';
			font-style: normal;
			font-weight: 300 800;
			font-stretch: 100%;
			font-display: swap;
			src: url(OpenSans.woff2) format('woff2');
			unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
		}

		* {
			font-family: 'Open Sans', system-ui, sans-serif;
		}

		@media print {
			form {
				display: none;
			}
		}
	</style>
	<script type="module">
		// @ts-check

		const form = /** @type {HTMLFormElement} */ (document.querySelector("form"))
		const template = /** @type {HTMLTemplateElement} */ (document.querySelector("template"))
		const addButton = /** @type {HTMLButtonElement} */ (document.querySelector("#add"))
		const ol = /** @type {HTMLOListElement} */ (document.querySelector("ol"))
		const currentYearSpan = /** @type {HTMLSpanElement} */ (document.getElementById("currentYear"))

		const now = new Date()
		const currentYear = now.getFullYear() - (now.getMonth() <= 6 ? 1 : 0)
		currentYearSpan.innerText = `${currentYear}/${currentYear + 1}`

		addButton.addEventListener("click", (ev) => {
			const fieldset = /** @type {HTMLFieldSetElement} */ (/** @type {HTMLFieldSetElement} */ (template.content.firstElementChild).cloneNode(true))
			form.append(fieldset);
			/** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="name"]')).focus()
		})

		form.addEventListener("submit", (ev) => {
			ev.preventDefault()
			renderList()
		})

		new MutationObserver(renderList).observe(form, { childList: true })

		function renderList() {
			const list = Array.from(form.querySelectorAll("fieldset"))
				.map(fieldsetToItem)
				.filter(nonEmptyItem)
				.sort(sortItems)
				.map(itemToListItem)
			ol.innerHTML = ""
			ol.append(...list)
		}

		/** @typedef {{name: string, role: string, association: string, roleSortOrder: number, associationSortOrder: number, year: number}} Item */

		/**
		 * @param {HTMLFieldSetElement} fieldset
		 * @return {Item}
		 */
		function fieldsetToItem(fieldset) {
			const nameInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="name"]'))
			const roleSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="role"]'))
			const associationSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="association"]'))
			const yearInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="year"]'))

			return {
				name: nameInput.value,
				role: roleSelect.selectedOptions[0].innerText,
				association: associationSelect.selectedOptions[0].innerText,
				roleSortOrder: parseInt(roleSelect.value),
				associationSortOrder: parseInt(associationSelect.value),
				year: parseInt(yearInput.value),
			}
		}

		/**
		 * @param {Item} item
		 * @return {boolean}
		 */
		function nonEmptyItem({ name, year }) {
			return name !== "" && !isNaN(year)
		}

		/**
		 * Roughly equivalent to a SQL ordering clause along the lines of
		 * `ORDER BY roleSortOrder ASC, year ASC, associationSortOrder ASC`
		 * with a special case handling for the current year.
		 *
		 * @param {Item} a
		 * @param {Item} b
		 * @return number
		 */
		function sortItems(a, b) {
			if (a.roleSortOrder === b.roleSortOrder) {
				if (a.year === b.year) {
					return a.associationSortOrder - b.associationSortOrder
				}
				if (a.year === currentYear) return -1
				if (b.year === currentYear) return 1
				return a.year - b.year
			}
			return a.roleSortOrder - b.roleSortOrder
		}

		/**
		 * @param {Item} item
		 * @return {HTMLLIElement}
		 */
		function itemToListItem(item) {
			const li = document.createElement("li")
			const b = document.createElement("b")
			b.innerText = item.name
			li.append(b)
			let role = item.role
			if (item.roleSortOrder === 1) {
				role = item.association === "Rotary" ? "Governatore" : "Rappresentante Distrettuale"
			}
			li.innerHTML += `<br><small>${role} ${item.association}<br>A.R. ${item.year}/${item.year + 1}</small>`
			return li
		}

		addButton.click()
	</script>
</head>

<body>
	<noscript>Devi abilitare JavaScript per utilizzare questa webapp.</noscript>
	<h1>Saluti! üëã</h1>
	<main style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr))">
		<form>
			<button type="button" id="add">‚ûï</button>
			<button type="button" onclick="window.print()">Stampa</button>
			<template>
				<fieldset>
					<input type="text" name="name" placeholder="Nome" oninput="this.closest('form').requestSubmit()">
					<select name="role" onchange="this.closest('form').requestSubmit()">
						<optgroup label="Direttivo distrettuale">
							<option value="001">Rappresentante Distrettuale/Governatore</option>
							<option value="002">Segretario Distrettuale</option>
							<option value="003">Tesoriere Distrettuale</option>
							<option value="004">Prefetto Distrettuale</option>
						</optgroup>
						<optgroup label="Esecutivo distrettuale">
							<option value="010">Presidente Commissione Azione Interna</option>
							<option value="011">Delegato di zona</option>
							<option value="012">Presidente Commissione Azione Interesse Pubblico</option>
							<option value="013">Presidente Commissione Azione Internazionale</option>
							<option value="014">Presidente Commissione Azione Nuove Generazioni</option>
							<option value="015">Presidente Commissione Azione Professionale</option>
							<option value="016">Presidente Commissione Comunicazione e Informatica</option>
							<option value="017">Presidente Commissione Cultura</option>
							<option value="018">Presidente Commissione Regolamento</option>
							<option value="019">Presidente Commissione Revisione dei Conti</option>
							<option value="020">Presidente Commissione Sport</option>
							<option value="021">Presidente Sottocommissione Fondazione Rotary</option>
							<option value="022">Presidente Sottocommissione Sviluppo Effettivo</option>
							<option value="023">Membro di commissione</option>
						</optgroup>
						<optgroup label="Cariche di club">
							<option value="100">Presidente</option>
							<option value="101">Vicepresidente</option>
							<option value="103">Segretario</option>
							<option value="104">Tesoriere</option>
							<option value="105">Prefetto</option>
							<option value="106">Consigliere</option>
							<option value="107">Socio</option>
						</optgroup>
					</select>
					<select name="association" onchange="this.closest('form').requestSubmit()">
						<option value="1">Rotary</option>
						<option value="2" selected>Rotaract</option>
						<option value="3">Interact</option>
					</select>
					<input type="number" name="year" min="1900" max="2100" placeholder="A.R." value="2023" oninput="this.closest('form').requestSubmit()">
					<button type="button" onclick="this.parentElement.remove()">üóëÔ∏è</button>
				</fieldset>
			</template>
		</form>
		<ol></ol>
	</main>
	<footer>
		<small>I calcoli sono effettuati considerando come annata corrente l'A.R. <span id="currentYear"></span>.</small>
	</footer>
</body>

</html>