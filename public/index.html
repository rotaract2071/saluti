<!DOCTYPE html>
<html lang="it" data-theme="dark">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%2210 0 100 100%22><text y=%22.90em%22 font-size=%2290%22>👋</text></svg>" />
	<title>Ordina i saluti del tuo evento Rotaract | saluto.app</title>
	<meta name="description" content="Ordina correttamente i saluti per il tuo prossimo evento Rotaract!">
	<link rel="stylesheet" href="pico.min.css" />
	<style>
		@font-face {
			font-family: 'Open Sans';
			font-style: normal;
			font-weight: 300 800;
			font-stretch: 100%;
			font-display: swap;
			src: url(OpenSans.woff2) format('woff2');
			unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+0304, U+0308, U+0329, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;
		}

		* {
			font-family: 'Open Sans', system-ui, sans-serif;
		}

		fieldset {
			border: var(--pico-border-width) solid var(--pico-form-element-border-color);
			border-radius: var(--pico-border-radius);
			padding: var(--pico-spacing);
			background: var(--pico-card-background-color);
		}

		.sticky {
			position: sticky;
			top: var(--pico-spacing);
		}

		@media print {
			* {
				background-color: white;
				color: black !important;
			}

			h1,
			#participants,
			button,
			footer {
				display: none;
			}

			.sticky {
				position: static;
			}
		}
	</style>
	<script type="module">
		// @ts-check

		const form = /** @type {HTMLFormElement} */ (document.querySelector("form"))
		const template = /** @type {HTMLTemplateElement} */ (document.querySelector("template"))
		const addButton = /** @type {HTMLButtonElement} */ (document.getElementById("add"))
		const shareButton = /** @type {HTMLButtonElement} */ (document.getElementById("share"))
		const ol = /** @type {HTMLOListElement} */ (document.querySelector("ol"))
		const currentYearSpan = /** @type {HTMLSpanElement} */ (document.getElementById("currentYear"))

		const now = new Date()
		const currentYear = now.getFullYear() - (now.getMonth() < 6 ? 1 : 0)

		form.addEventListener("submit", (e) => e.preventDefault())
		form.addEventListener("submit", renderList)
		new MutationObserver(renderList).observe(form, { childList: true })

		addButton.addEventListener("click", () => {
			const fieldset = /** @type {HTMLFieldSetElement} */ (/** @type {HTMLFieldSetElement} */ (template.content.firstElementChild).cloneNode(true))

			const nameInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="name"]'))
			const roleSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="role"]'))
			const organizationSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="organization"]'))
			const yearInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="year"]'))
			const clubSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="club"]'))
			const clubFoundationDateInput = /** @type {HTMLInputElement} */(fieldset.querySelector('input[name="club-foundation-date"]'))
			const removeButton = /** @type {HTMLButtonElement} */ (fieldset.querySelector("button.remove"))

			const rolesOptions = roleSelect.options
			const clubOptGroups = clubSelect.querySelectorAll("optgroup")
			const noneClubOption = /** @type {HTMLOptionElement} */ (clubSelect.querySelector("option.none"))

			nameInput.addEventListener("input", requestFormSubmit)
			roleSelect.addEventListener("change", requestFormSubmit)
			organizationSelect.addEventListener("change", () => filterRoles(rolesOptions, getSelectedOptionText(organizationSelect)))
			organizationSelect.addEventListener("change", () => filterClubs(clubOptGroups, getSelectedOptionText(organizationSelect), noneClubOption))
			organizationSelect.addEventListener("change", () => updateClubFoundationDate(clubFoundationDateInput, clubSelect, noneClubOption))
			organizationSelect.addEventListener("change", requestFormSubmit)
			yearInput.addEventListener("input", requestFormSubmit)
			clubSelect.addEventListener("input", () => updateClubFoundationDate(clubFoundationDateInput, clubSelect, noneClubOption))
			clubSelect.addEventListener("input", requestFormSubmit)
			clubFoundationDateInput.addEventListener("input", requestFormSubmit)
			removeButton.addEventListener("click", () => fieldset.remove())

			yearInput.value = currentYear.toString()
			organizationSelect.dispatchEvent(new Event("change"))
			form.append(fieldset)
			nameInput.focus()
		})

		shareButton.addEventListener("click", () => {
			const text = listItemsToText(ol.querySelectorAll("li"))
			if (text === "") {
				alert("Inserisci almeno un nominativo.")
				return
			}
			try {
				navigator.share({ text })
			} catch {
				navigator.clipboard.writeText(text)
				alert("Saluti copiati negli appunti!")
			}
		})

		currentYearSpan.innerText = `${currentYear}/${currentYear + 1}`
		addButton.click()

		/** @typedef {{name: string, organization: string, organizationSortOrder: number, role: string, roleSortOrder: number, year: number, club: string, clubFoundationDate: Date}} Person */

		function requestFormSubmit() {
			form.requestSubmit()
		}

		/**
		 * @param {HTMLSelectElement} select
		 * @returns {string}
		 */
		function getSelectedOptionText(select) {
			return select.selectedOptions[0].innerText
		}

		/**
		 * @param {HTMLOptionsCollection} optionsCollection
		 * @param {string} organization
		 */
		function filterRoles(optionsCollection, organization) {
			const options = Array.from(optionsCollection)
			options.forEach(hide)
			options.filter((option) => option.dataset.organization === undefined || option.dataset.organization === organization).forEach(show)
			options.filter((option) => !option.hidden)[0].selected = true
		}

		/**
		 * @param {NodeListOf<HTMLOptGroupElement>} optGroupList
		 * @param {string} organization
		 * @param {HTMLOptionElement} noneClubOption
		 */
		function filterClubs(optGroupList, organization, noneClubOption) {
			const optGroups = Array.from(optGroupList)
			optGroups.forEach((optGroup) => {
				hide(optGroup)
				optGroup.querySelectorAll("option").forEach(hide)
			})
			optGroups.filter((optGroup) => optGroup.dataset.organization === organization).forEach((optGroup) => {
				show(optGroup)
				optGroup.querySelectorAll("option").forEach(show)
			})
			noneClubOption.selected = true
		}

		/**
		 * @param {HTMLOptionElement|HTMLOptGroupElement} element
		 */
		function show(element) {
			toggleVisibility(element, true)
		}

		/**
		 * @param {HTMLOptionElement|HTMLOptGroupElement} element
		 */
		function hide(element) {
			toggleVisibility(element, false)
		}

		/**
		 * @param {HTMLOptionElement|HTMLOptGroupElement} element
		 * @param {boolean} visible
		 */
		function toggleVisibility(element, visible) {
			element.hidden = !visible
			element.disabled = !visible
		}

		/**
		 * @param {HTMLInputElement} clubFoundationDateInput
		 * @param {HTMLSelectElement} clubSelect
		 * @param {HTMLOptionElement} noneClubOption
		 */
		function updateClubFoundationDate(clubFoundationDateInput, clubSelect, noneClubOption) {
			clubFoundationDateInput.value = clubSelect.value
			clubFoundationDateInput.disabled = clubSelect.value !== "" || noneClubOption.isSameNode(clubSelect.selectedOptions[0])
		}

		function renderList() {
			ol.replaceChildren(...fieldsetsToListItems(form.querySelectorAll("fieldset")))
		}

		/**
		 * @param {NodeListOf<HTMLFieldSetElement>} fieldsets 
		 * @returns {HTMLLIElement[]}
		 */
		function fieldsetsToListItems(fieldsets) {
			return Array
				.from(fieldsets)
				.map(fieldsetToPerson)
				.map(detailTemporallyRoleOf)
				.filter(personHasNameAndYear)
				.sort(compare)
				.map(personToListItem)
		}

		/**
		 * @param {NodeListOf<HTMLLIElement>} listItems
		 * @returns {string}
		 */
		function listItemsToText(listItems) {
			return Array
				.from(listItems)
				.map((listItem, index) => `${index + 1} - ${listItem.innerText}`)
				.join("\n\n")
		}

		/**
		 * @param {HTMLFieldSetElement} fieldset
		 * @returns {Person}
		 */
		function fieldsetToPerson(fieldset) {
			const nameInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="name"]'))
			const roleSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="role"]'))
			const organizationSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="organization"]'))
			const yearInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="year"]'))
			const clubSelect = /** @type {HTMLSelectElement} */ (fieldset.querySelector('select[name="club"]'))
			const clubFoundationDateInput = /** @type {HTMLInputElement} */ (fieldset.querySelector('input[name="club-foundation-date"]'))

			return {
				name: nameInput.value,
				organization: getSelectedOptionText(organizationSelect),
				organizationSortOrder: parseInt(organizationSelect.value),
				role: getSelectedOptionText(roleSelect),
				roleSortOrder: parseInt(roleSelect.value),
				year: parseInt(yearInput.value),
				club: getSelectedOptionText(clubSelect),
				clubFoundationDate: new Date(clubFoundationDateInput.value),
			}
		}

		/**
		 * @param {Person} person
		 * @returns {Person}
		 */
		function detailTemporallyRoleOf(person) {
			if (person.year < currentYear - 1) {
				person.role = `Past ${person.role}`
			} else if (person.year === currentYear - 1) {
				person.role = `Immediate Past ${person.role}`
			} else if (person.year === currentYear + 1) {
				person.role = `${person.role} Incoming`
			} else if (person.year === currentYear + 2) {
				person.role = `${person.role} Eletto`
			} else if (person.year === currentYear + 3) {
				person.role = `${person.role} Nominato`
			}
			return person
		}

		/**
		 * @param {Person} person
		 * @returns {boolean}
		 */
		function personHasNameAndYear({ name, year }) {
			return name !== "" && !isNaN(year)
		}

		/**
		 * @param {Person} a
		 * @param {Person} b
		 * @returns {number}
		 */
		function compare(a, b) {
			// Se cariche diverse, ordina per carica
			if (a.roleSortOrder !== b.roleSortOrder) return a.roleSortOrder - b.roleSortOrder

			// Hanno la stessa carica

			// Se anni diversi
			if (a.year !== b.year) {
				// Gli in carica hanno sempre la precedenza
				if (a.year === currentYear) return -1
				if (b.year === currentYear) return 1

				// Gli immediate past vengono subito dopo
				if (a.year === currentYear - 1) return -1
				if (b.year === currentYear - 1) return 1

				// Altrimenti, ordina per anno crescente
				return a.year - b.year
			}

			// Hanno stessa carica e stesso anno

			// Se associazioni diverse
			if (a.organization !== b.organization) {
				// Caso particolare: Governatore/R.D. dell'anno corrente
				// In questo caso si dà precedenza al Rotary
				if (a.roleSortOrder === 1 && a.year === currentYear) {
					if (a.organization === "Rotary") return -1
					if (b.organization === "Rotary") return 1
				}

				// Ordina per associazione
				return a.organizationSortOrder - b.organizationSortOrder
			}

			// Hanno stessa carica, stesso anno e stessa associazione

			// Ordina per data di fondazione del club
			return a.clubFoundationDate.getTime() - b.clubFoundationDate.getTime()
		}

		/**
		 * @param {Person} person
		 * @returns {HTMLLIElement}
		 */
		function personToListItem(person) {
			const li = document.createElement("li")
			const b = document.createElement("b")
			b.innerText = person.name
			li.append(b)
			li.innerHTML += `<br><small>${person.role} ${person.organization}${person.roleSortOrder >= 200 && !isNaN(person.clubFoundationDate.valueOf()) ? `<br>${person.organization} Club ${person.club}` : ""}<br>A.R. ${person.year}/${person.year + 1}</small>`
			return li
		}
	</script>
</head>

<body class="container">
	<noscript>Abilita JavaScript per utilizzare questa web app.</noscript>
	<main>
		<h1 style="text-align: center">saluto.app</h1>
		<div class="grid">
			<section id="participants">
				<h2>Partecipanti</h2>
				<form>
					<template>
						<fieldset>
							<label>
								Nome
								<input type="text" name="name" placeholder="Nome" autocapitalize="words" autocomplete="name">
							</label>
							<label>
								Associazione
								<select name="organization">
									<option value="1">Rotaract</option>
									<option value="2">Rotary</option>
									<option value="3">Interact</option>
								</select>
							</label>
							<label>
								Carica
								<select name="role">
									<optgroup label="Direttivo distrettuale">
										<option data-organization="Rotary" value="001">Governatore</option>
										<option data-organization="Rotaract" value="001">Rappresentante Distrettuale</option>
										<option data-organization="Interact" value="001">Rappresentante Distrettuale</option>
										<option data-organization="Rotary" value="002">Vicegovernatore</option>
										<option value="003">Relatore</option>
										<option value="004">Carica politica</option>
										<option value="005">Carica militare</option>
										<option value="006">Carica ecclesiastica</option>
										<option value="007">Segretario Distrettuale</option>
										<option value="008">Tesoriere Distrettuale</option>
										<option value="009">Prefetto Distrettuale</option>
									</optgroup>
									<optgroup label="Esecutivo distrettuale">
										<option data-organization="Rotary" value="100">Assistente del Governatore</option>
										<option data-organization="Rotaract" value="110">Presidente Commissione Azione Interna</option>
										<option data-organization="Rotaract" value="111">Presidente Commissione Azione Interesse Pubblico</option>
										<option data-organization="Rotaract" value="112">Presidente Commissione Azione Internazionale</option>
										<option data-organization="Rotaract" value="113">Presidente Commissione Azione Nuove Generazioni</option>
										<option data-organization="Rotaract" value="114">Presidente Commissione Azione Professionale</option>
										<option data-organization="Rotary" value="120">Presidente Commissione Via d'Azione</option>
										<option data-organization="Rotaract" value="130">Presidente Commissione Comunicazione e Informatica</option>
										<option data-organization="Rotaract" value="131">Presidente Commissione Cultura</option>
										<option data-organization="Rotaract" value="132">Presidente Commissione Regolamento</option>
										<option data-organization="Rotaract" value="133">Presidente Commissione Revisione dei Conti</option>
										<option data-organization="Rotaract" value="134">Presidente Commissione Sport</option>
										<option data-organization="Rotary" value="140">Presidente Commissione</option>
										<option data-organization="Rotaract" value="150">Presidente Sottocommissione Fondazione Rotary</option>
										<option data-organization="Rotaract" value="151">Presidente Sottocommissione Sviluppo Effettivo</option>
										<option data-organization="Rotary" value="160">Presidente Sottocommissione</option>
										<option data-organization="Rotaract" value="170">Delegato di zona</option>
									</optgroup>
									<optgroup label="Cariche di club">
										<option value="200">Presidente</option>
										<option data-organization="Rotary" value="201">Delegato Rotary per il Rotaract</option>
										<option value="202">Vicepresidente</option>
										<option value="203">Segretario</option>
										<option value="204">Tesoriere</option>
										<option value="205">Prefetto</option>
										<option value="206">Consigliere</option>
										<option value="207">Socio</option>
									</optgroup>
								</select>
							</label>
							<label>
								A.R.
								<input type="number" name="year" min="1900" max="2100" placeholder="A.R.">
							</label>
							<details>
								<summary>Campi opzionali</summary>
								<label>
									Club
									<select name="club">
										<option value="" class="none">Nessuno</option>
										<option value="">Altro</option>
										<optgroup data-organization="Rotaract" label="Rotaract Club Distretto 2071">
											<option value="1968-12-05">Arezzo</option>
											<option value="1968-04-11">Carrara e Massa</option>
											<option value="2004-05-28">Cascina</option>
											<!-- <option value="2015-05-22">Casentino</option> -->
											<option value="2011-07-06">Cecina Rosignano</option>
											<option value="2014-06-08">Chiusi Chianciano Montepulciano</option>
											<option value="1969-05-22">Empoli</option>
											<option value="1994-06-13">Fiesole</option>
											<option value="1968-03-18">Firenze</option>
											<!-- <option value="2008-05-30">Firenze Bisenzio</option> -->
											<option value="2024-07-03">Firenze Bisenzio Michelangelo</option>
											<option value="2000-09-25">Firenze Brunelleschi</option>
											<option value="2005-06-27">Firenze Centenario</option>
											<!-- <option value="2001-12-04">Firenze Certosa</option> -->
											<option value="1968-09-07">Firenze Est</option>
											<option value="1981-05-13">Firenze Nord</option>
											<!-- <option value="2016-04-27">Firenze Sesto Calenzano</option> -->
											<option value="2019-10-22">Firenze Ovest</option>
											<!-- <option value="2024-07-01">Firenze Sesto Michelangelo</option> -->
											<option value="1987-03-14">Firenze Sud</option>
											<!-- <option value="1984-07-15">Follonica</option> -->
											<option value="1987-05-25">Grosseto</option>
											<!-- <option value="2014-07-04">Isola D'Elba</option> -->
											<option value="1969-01-01">Livorno</option>
											<option value="1969-02-04">Lucca</option>
											<option value="2016-10-27">Monte Argentario</option>
											<option value="1982-05-02">Mugello</option>
											<option value="2005-07-23">Piombino</option>
											<option value="1970-03-07">Pisa</option>
											<option value="1977-03-18">Pistoia Montecatini Terme</option>
											<option value="1988-01-01">Pontedera</option>
											<option value="1968-05-05">Prato</option>
											<!-- <option value="2012-01-07">Rosignano Solvay</option> -->
											<option value="2024-02-06">San Casciano</option>
											<!-- <option value="2014-06-30">San Casciano Chianti</option> -->
											<option value="1975-01-10">San Miniato</option>
											<option value="1969-03-14">Siena</option>
											<!-- <option value="2015-05-04">Valdarno Fiorentino</option> -->
											<!-- <option value="2015-06-28">Valdarno Masaccio</option> -->
											<option value="1987-01-01">Valdelsa</option>
											<option value="1969-05-26">Viareggio Versilia</option>
											<option value="1982-04-01">Volterra</option>
										</optgroup>
										<optgroup data-organization="Rotary" label="Rotary Club Distretto 2071">
											<option value="1997-05-29">Alta Valdelsa</option>
											<option value="2023-04-19">Antiche Valli del Serchio</option>
											<option value="1949-01-18">Arezzo</option>
											<option value="1973-06-08">Arezzo Est</option>
											<option value="2018-04-30">Bagno a Ripoli</option>
											<option value="2016-12-01">Bisenzio Le Signe</option>
											<option value="1948-08-02">Carrara e Massa</option>
											<option value="2001-12-13">Cascina e Monte Pisano</option>
											<option value="1998-06-26">Casentino</option>
											<option value="2015-05-29">Castelfranco di Sotto - Valdarno Inferiore</option>
											<option value="1976-06-21">Cecina</option>
											<option value="1961-05-16">Chianciano - Chiusi - Montepulciano</option>
											<option value="2001-06-15">Cortona Val di Chiana</option>
											<option value="2016-07-01">E-Club Distretto 2071</option>
											<option value="1957-10-31">Empoli</option>
											<option value="1990-12-10">Fiesole</option>
											<option value="2015-02-26">Figline Incisa Valdarno</option>
											<option value="1925-09-21">Firenze</option>
											<option value="2014-12-22">Firenze "Amerigo Vespucci"</option>
											<option value="1993-08-12">Firenze Brunelleschi</option>
											<option value="1997-05-21">Firenze Certosa</option>
											<option value="1968-02-12">Firenze Est</option>
											<option value="2018-01-23">Firenze Granducato</option>
											<option value="1997-06-12">Firenze Lorenzo il Magnifico</option>
											<option value="1974-10-26">Firenze Nord</option>
											<option value="1980-05-01">Firenze Ovest</option>
											<option value="1997-06-09">Firenze Sesto Michelangelo</option>
											<option value="1969-06-09">Firenze Sud</option>
											<option value="1997-08-07">Firenze Valdisieve</option>
											<option value="1966-05-23">Follonica</option>
											<option value="2023-04-05">Forte dei Marmi</option>
											<option value="1968-02-27">Fucecchio S.Croce sull'Arno</option>
											<option value="1954-05-14">Grosseto</option>
											<option value="1959-07-23">Isola d'Elba</option>
											<option value="1925-04-14">Livorno</option>
											<option value="2002-01-15">Livorno Mascagni</option>
											<option value="2000-06-13">Livorno Sud e Colline Pisano-Livornesi</option>
											<option value="1935-06-13">Lucca</option>
											<option value="2022-10-30">Lucca Giacomo Puccini</option>
											<option value="2016-04-19">Lunigiana Pontremoli</option>
											<option value="2005-05-24">Marina di Massa Riviera Apuana del Centenario</option>
											<option value="1966-05-22">Massa Marittima</option>
											<option value="2023-06-19">Montalcino</option>
											<option value="2024-01-01">Monte Amiata Community</option>
											<option value="2012-04-30">Monte Argentario</option>
											<option value="2008-04-15">Montecarlo - Piana di Lucca</option>
											<option value="1977-05-04">Mugello</option>
											<option value="1969-11-03">Orbetello - Costa d'Argento</option>
											<option value="2023-09-05">Pegaso-Alumni Distretto-2071</option>
											<option value="1956-09-16">Piombino</option>
											<option value="1934-08-01">Pisa</option>
											<option value="1980-06-19">Pisa - Galilei</option>
											<option value="2002-04-30">Pisa Pacinotti</option>
											<option value="1950-11-30">Pistoia - Montecatini Terme</option>
											<option value="1997-03-19">Pistoia Montecatini Terme 'Marino Marini'</option>
											<option value="1980-05-13">Pitigliano - Sorano - Manciano</option>
											<option value="1959-07-23">Pontedera</option>
											<option value="1957-04-02">Prato</option>
											<option value="1995-11-20">Prato Filippo Lippi</option>
											<option value="2010-03-26">Rosignano Solvay</option>
											<option value="2012-10-17">San Casciano - Chianti</option>
											<option value="2022-05-20">San Giuliano Terme - Fibonacci</option>
											<option value="1999-05-12">San Miniato</option>
											<option value="1996-05-08">Sansepolcro - Piero della Francesca</option>
											<option value="2022-03-07">Santa Croce Montopoli - Comprensorio del cuoio</option>
											<option value="2013-06-13">Scandicci</option>
											<option value="1950-08-10">Siena</option>
											<option value="1978-01-23">Siena Est</option>
											<option value="2015-01-21">Siena Montaperti</option>
											<option value="1967-08-23">Valdarno</option>
											<option value="1970-06-15">Valdelsa</option>
											<option value="1960-02-10">Viareggio Versilia</option>
											<option value="1958-07-22">Volterra</option>
										</optgroup>
									</select>
								</label>
								<label>
									Data di fondazione del Club
									<input type="date" name="club-foundation-date">
								</label>
							</details>
							<button type="button" class="secondary outline remove">🗑️ Rimuovi</button>
						</fieldset>
					</template>
				</form>
				<button type="button" id="add">➕ Aggiungi</button>
			</section>
			<section>
				<h2>Ordine dei saluti</h2>
				<div class="sticky">
					<button type="button" id="share">🔁 Condividi</button>
					<button type="button" onclick="window.print()">🖨️ Stampa</button>
					<ol></ol>
				</div>
			</section>
		</div>
	</main>
	<footer style="text-align: center">
		<small>
			Credits: <a href="https://danieleambrosino.it" target="_blank">Daniele Ambrosino</a>, <a href="https://linktr.ee/grazia_pachioli" target="_blank">Grazia Pachioli</a>, <a href="https://instagram.com/malvinarosseti" target="_blank">Malvina Rosseti</a>
			<br>
			<a target="_blank" href="https://rotaract2071.org">Distretto Rotaract 2071</a>
			<br>
			Comm. Comunicazione e Informatica A.R. 2024/2025
			<br>
			L'algoritmo considera come annata corrente l'A.R. <span id="currentYear"></span>
		</small>
	</footer>
</body>

</html>